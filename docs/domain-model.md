# Domain Model

Detailed type definitions for Autonoe domain model. For overview, see [SPEC.md Section 2.3](../SPEC.md#23-domain-model).

## Stream Events

**StreamEvent** - Discriminated union of all event types

| Type                      | Description                |
| ------------------------- | -------------------------- |
| StreamEventText           | Agent's text response      |
| StreamEventThinking       | Agent's internal reasoning |
| StreamEventToolInvocation | Agent's tool call request  |
| StreamEventToolResponse   | Tool execution result      |
| StreamEventEnd            | Session termination        |
| StreamEventError          | SDK error wrapped as event |

### StreamEventText

| Field | Type          | Description              |
| ----- | ------------- | ------------------------ |
| type  | 'stream_text' | Event type discriminator |
| text  | string        | Text content             |

### StreamEventThinking

| Field    | Type              | Description                |
| -------- | ----------------- | -------------------------- |
| type     | 'stream_thinking' | Event type discriminator   |
| thinking | string            | Thinking/reasoning content |

Behavior:

- Automatically generated by Claude Agent SDK (no configuration required)
- Summarized in Claude 4 models, full output in Claude 3.7
- Displayed in debug mode only (via `logger.debug`)
- Truncated to 200 characters in debug output

### StreamEventToolInvocation

| Field | Type                      | Description              |
| ----- | ------------------------- | ------------------------ |
| type  | 'stream_tool_invocation'  | Event type discriminator |
| name  | string                    | Tool name                |
| input | Record\<string, unknown\> | Tool parameters          |

### StreamEventToolResponse

| Field     | Type                   | Description                       |
| --------- | ---------------------- | --------------------------------- |
| type      | 'stream_tool_response' | Event type discriminator          |
| toolUseId | string                 | Corresponding tool use ID         |
| content   | string                 | Result content                    |
| isError   | boolean                | Whether the tool execution failed |

### StreamEventEnd

Discriminated union for session termination.

| Outcome         | Variant Fields                     | Description            |
| --------------- | ---------------------------------- | ---------------------- |
| completed       | result?: string                    | Normal completion      |
| execution_error | messages: string[]                 | Execution errors       |
| max_iterations  | -                                  | Hit iteration limit    |
| budget_exceeded | -                                  | API cost limit hit     |
| quota_exceeded  | message?: string, resetTime?: Date | Subscription quota hit |

Common fields: `type: 'stream_end'`, `outcome: SessionOutcome`, `totalCostUsd?: number`

### StreamEventError

| Field   | Type           | Description                 |
| ------- | -------------- | --------------------------- |
| type    | 'stream_error' | Event type discriminator    |
| message | string         | Error message               |
| stack   | string?        | Stack trace (for debugging) |

### MessageStream Error Handling

The SDK may throw errors after yielding `stream_end` for certain outcomes (e.g., quota exceeded causes Claude Code to exit with code 1). The `ClaudeAgentClient` wrapper handles this by:

1. Wrap SDK errors as `StreamEventError` events (yield instead of throw)
2. Session checks if `stream_end` was already received:
   - If yes: Log error at debug level and continue (expected behavior)
   - If no: Throw the error (real failure)

This encapsulates SDK-specific behavior in the infrastructure layer, keeping the domain layer (Session) clean.

---

## Value Objects

### DeliverableInput

Single deliverable definition (for create tool).

| Field              | Type     | Description                          |
| ------------------ | -------- | ------------------------------------ |
| id                 | string   | Unique deliverable identifier        |
| description        | string   | Clear description of the deliverable |
| acceptanceCriteria | string[] | List of acceptance criteria          |

### CreateDeliverableInput

Input for create tool.

| Field        | Type               | Description                     |
| ------------ | ------------------ | ------------------------------- |
| deliverables | DeliverableInput[] | Array of deliverables to create |

### SetDeliverableStatusInput

Input for set_status tool.

| Field         | Type                               | Description              |
| ------------- | ---------------------------------- | ------------------------ |
| deliverableId | string                             | Deliverable ID to update |
| status        | 'pending' \| 'passed' \| 'blocked' | New status               |

### OperationResult

Result returned by application services.

| Field   | Type    | Description                   |
| ------- | ------- | ----------------------------- |
| success | boolean | Whether operation succeeded   |
| message | string  | Human-readable result message |
| error   | string? | Error code (if failed)        |

---

## Entities

### Deliverable

Verifiable work unit with acceptance criteria.

| Field              | Type                               | Description                          |
| ------------------ | ---------------------------------- | ------------------------------------ |
| id                 | string                             | Unique identifier (e.g., DL-001)     |
| description        | string                             | Clear description of the deliverable |
| acceptanceCriteria | string[]                           | Verifiable conditions for completion |
| status             | 'pending' \| 'passed' \| 'blocked' | Current status                       |

**Status Semantics:**

| Status  | Meaning                                                 |
| ------- | ------------------------------------------------------- |
| pending | Not started or reset (bugs found in passed deliverable) |
| passed  | All acceptance criteria verified                        |
| blocked | External constraints prevent completion                 |

**Acceptance Criteria Examples:**

| Type              | Examples                                                                 |
| ----------------- | ------------------------------------------------------------------------ |
| Feature           | "User can login via OAuth", "Error message shown on invalid credentials" |
| Refactor          | "API response time reduced by 50%", "Code coverage maintained above 80%" |
| Technical Rewrite | "New and old API behavior identical", "No breaking changes"              |

### Deliverable State Machine

```
┌─────────────────────────────────────────────────────────────┐
│                    Deliverable State Machine                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────┐                                              │
│   │  create  │                                              │
│   └────┬─────┘                                              │
│        │                                                    │
│        ▼                                                    │
│   ┌──────────┐    set_status('passed')       ┌──────────┐  │
│   │ pending  │ ─────────────────────────────▶│  passed  │  │
│   │ status=  │                               │ status=  │  │
│   │'pending' │◀─────────────────────────────│ 'passed' │  │
│   └────┬─────┘    set_status('pending')      └──────────┘  │
│        │                                           ▲        │
│        │ set_status('blocked')                     │        │
│        ▼                                           │        │
│   ┌──────────┐                                     │        │
│   │ blocked  │─────────────────────────────────────┘        │
│   │ status=  │    set_status('passed')                      │
│   │'blocked' │                                              │
│   └────┬─────┘                                              │
│        │                                                    │
│        └─────────────── set_status('pending') ──────────────┤
│                                    │                        │
│                                    ▼                        │
│                              (back to pending)              │
└─────────────────────────────────────────────────────────────┘
```

| Transition            | From            | To      | Constraint            |
| --------------------- | --------------- | ------- | --------------------- |
| create                | -               | pending | Initial state         |
| set_status('passed')  | pending/blocked | passed  | Sets status='passed'  |
| set_status('blocked') | pending         | blocked | Sets status='blocked' |
| set_status('pending') | passed/blocked  | pending | Sets status='pending' |

Invariant: Single `status` field eliminates invalid state combinations.

---

## Aggregates

### DeliverableStatus

Root aggregate for deliverable tracking.

| Field        | Type          | Description                           |
| ------------ | ------------- | ------------------------------------- |
| createdAt    | string        | Creation date (YYYY-MM-DD)            |
| updatedAt    | string        | Last update date, updated on tool use |
| deliverables | Deliverable[] | All tracked deliverables              |

Persistence: `.autonoe/status.json`

---

## Repository Interfaces

### DeliverableStatusReader

Read-only interface for checking deliverable status.

| Method | Signature                          | Description                 |
| ------ | ---------------------------------- | --------------------------- |
| exists | `() => Promise<boolean>`           | Check if status file exists |
| load   | `() => Promise<DeliverableStatus>` | Load status or return empty |

Used by `SessionRunner` to determine loop termination and instruction selection.

### DeliverableRepository

Full repository interface extending reader.

| Method | Signature                                      | Description        |
| ------ | ---------------------------------------------- | ------------------ |
| save   | `(status: DeliverableStatus) => Promise<void>` | Persist to storage |

Implementation lives in infrastructure layer (`packages/agent`).

---

## Enums

### SessionOutcome

| Value             | Description               |
| ----------------- | ------------------------- |
| 'completed'       | Session finished normally |
| 'max_iterations'  | Hit turn/iteration limit  |
| 'execution_error' | Error during execution    |
| 'budget_exceeded' | API cost limit hit        |
| 'quota_exceeded'  | Subscription quota hit    |

---

## Interface Types

Types that define the contract between Core and Infrastructure layers. These are not pure domain concepts but necessary abstractions for dependency inversion.

### McpServer

External tool server configuration. Defines how Core communicates tool server requirements to Infrastructure.

| Field   | Type      | Description               |
| ------- | --------- | ------------------------- |
| command | string    | Server executable command |
| args    | string[]? | Command arguments         |

---

## Type Aliases

### MessageStream

Async stream of agent events with interrupt capability.

| Field       | Type                                | Description                 |
| ----------- | ----------------------------------- | --------------------------- |
| (generator) | AsyncGenerator\<StreamEvent, void\> | Yields stream events        |
| interrupt   | () => Promise\<void\>               | Interrupt the ongoing query |

---

**Type Definitions:** See `packages/core/src/types.ts`
