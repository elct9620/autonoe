name: Build Cloud Image

on:
  workflow_call:
    inputs:
      tag-strategy:
        required: true
        type: string
        description: 'snapshot or release'
      version-tag:
        required: false
        type: string
        description: 'Version tag for release (e.g., v1.0.0)'

env:
  UBUNTU_VERSION: '24.04'
  UBUNTU_CODENAME: 'noble'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build linux-x64 binary
        working-directory: apps/cli
        run: |
          mkdir -p dist
          bun build bin/autonoe.ts --compile --minify \
            --target=bun-linux-x64 \
            --outfile=dist/autonoe

      - name: Install libguestfs-tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libguestfs-tools

      - name: Download Ubuntu Cloud Image
        run: |
          curl -LO "https://cloud-images.ubuntu.com/${{ env.UBUNTU_CODENAME }}/current/${{ env.UBUNTU_CODENAME }}-server-cloudimg-amd64.img"

      - name: Determine output filename
        id: filename
        run: |
          if [[ "${{ inputs.tag-strategy }}" == "release" && -n "${{ inputs.version-tag }}" ]]; then
            # Extract version without 'v' prefix (e.g., v1.0.0 -> 1.0.0)
            VERSION="${{ inputs.version-tag }}"
            VERSION="${VERSION#v}"
            echo "name=autonoe-${VERSION}-ubuntu-${{ env.UBUNTU_VERSION }}.img" >> "$GITHUB_OUTPUT"
          else
            echo "name=autonoe-ubuntu-${{ env.UBUNTU_VERSION }}.img" >> "$GITHUB_OUTPUT"
          fi

      - name: Customize Cloud Image
        env:
          LIBGUESTFS_BACKEND: direct
          LIBGUESTFS_BACKEND_SETTINGS: force_tcg
        run: |
          cp "${{ env.UBUNTU_CODENAME }}-server-cloudimg-amd64.img" "${{ steps.filename.outputs.name }}"

          virt-customize -a "${{ steps.filename.outputs.name }}" \
            --copy-in apps/cli/dist/autonoe:/usr/local/bin \
            --chmod 0755:/usr/local/bin/autonoe

      - name: Generate checksum
        if: inputs.tag-strategy == 'release'
        run: |
          sha256sum "${{ steps.filename.outputs.name }}" > "${{ steps.filename.outputs.name }}.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: cloud-image
          path: ${{ steps.filename.outputs.name }}*
          retention-days: ${{ inputs.tag-strategy == 'release' && 90 || 7 }}
          if-no-files-found: error
